#!/usr/bin/env bash
set -euo pipefail

# Go TUI Project Generator
# Creates a new Go project with Bubble Tea + lipgloss

VERSION="1.0.0"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

usage() {
    cat << EOF
Usage: create-go-tui <project-name> [options]

Creates a new Go TUI project with Bubble Tea + lipgloss.

Options:
  --dir <path>       Target directory (default: current dir)
  --module <path>    Go module path (default: github.com/user/project-name)
  --with-devenv      Include devenv.nix setup
  --no-interactive   Fail if required options missing
  --help             Show this help message
  --version          Show version

Examples:
  create-go-tui my-app
  create-go-tui my-app --module github.com/myuser/my-app
  create-go-tui my-app --dir ~/Projects --with-devenv
EOF
}

log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[OK]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# Default values
PROJECT_NAME=""
TARGET_DIR="."
MODULE_PATH=""
WITH_DEVENV=false
NO_INTERACTIVE=false

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --dir)
            TARGET_DIR="$2"
            shift 2
            ;;
        --module)
            MODULE_PATH="$2"
            shift 2
            ;;
        --with-devenv)
            WITH_DEVENV=true
            shift
            ;;
        --no-interactive)
            NO_INTERACTIVE=true
            shift
            ;;
        --help)
            usage
            exit 0
            ;;
        --version)
            echo "create-go-tui v$VERSION"
            exit 0
            ;;
        -*)
            log_error "Unknown option: $1"
            usage
            exit 1
            ;;
        *)
            if [[ -z "$PROJECT_NAME" ]]; then
                PROJECT_NAME="$1"
            else
                log_error "Unexpected argument: $1"
                usage
                exit 1
            fi
            shift
            ;;
    esac
done

# Interactive prompts for missing required values
if [[ -z "$PROJECT_NAME" ]]; then
    if [[ "$NO_INTERACTIVE" == true ]]; then
        log_error "Project name is required"
        exit 1
    fi
    read -rp "Project name: " PROJECT_NAME
    if [[ -z "$PROJECT_NAME" ]]; then
        log_error "Project name cannot be empty"
        exit 1
    fi
fi

# Interactive prompts for module path
if [[ -z "$MODULE_PATH" ]]; then
    if [[ "$NO_INTERACTIVE" == false ]]; then
        read -rp "Go module path [github.com/user/$PROJECT_NAME]: " MODULE_PATH
    fi
    if [[ -z "$MODULE_PATH" ]]; then
        MODULE_PATH="github.com/user/$PROJECT_NAME"
    fi
fi

# Interactive prompts for optional features
if [[ "$NO_INTERACTIVE" == false ]]; then
    if [[ "$WITH_DEVENV" == false ]]; then
        read -rp "Include devenv.nix setup? [y/N] " response
        if [[ "$response" =~ ^[Yy]$ ]]; then
            WITH_DEVENV=true
        fi
    fi
fi

# Resolve paths
PROJECT_DIR="$TARGET_DIR/$PROJECT_NAME"
PROJECT_DIR=$(realpath -m "$PROJECT_DIR")

if [[ -e "$PROJECT_DIR" ]]; then
    log_error "Directory already exists: $PROJECT_DIR"
    exit 1
fi

log_info "Creating project: $PROJECT_NAME"
log_info "Location: $PROJECT_DIR"
log_info "Module: $MODULE_PATH"
[[ "$WITH_DEVENV" == true ]] && log_info "Including: devenv.nix setup"

# Create directory structure
mkdir -p "$PROJECT_DIR/internal/tui"

# Create go.mod
cat > "$PROJECT_DIR/go.mod" << EOF
module $MODULE_PATH

go 1.22
EOF

# Create main.go
cat > "$PROJECT_DIR/main.go" << 'EOF'
package main

import (
	"fmt"
	"os"

	"MODULE_PATH/internal/tui"

	tea "github.com/charmbracelet/bubbletea"
)

func main() {
	p := tea.NewProgram(tui.NewModel(), tea.WithAltScreen())
	if _, err := p.Run(); err != nil {
		fmt.Fprintf(os.Stderr, "Error: %v\n", err)
		os.Exit(1)
	}
}
EOF
sed -i "s|MODULE_PATH|$MODULE_PATH|g" "$PROJECT_DIR/main.go"

# Create internal/tui/model.go
cat > "$PROJECT_DIR/internal/tui/model.go" << 'EOF'
package tui

import (
	"github.com/charmbracelet/bubbles/key"
	tea "github.com/charmbracelet/bubbletea"
)

// Model represents the application state
type Model struct {
	count    int
	quitting bool
	keys     keyMap
}

// NewModel creates a new Model with default values
func NewModel() Model {
	return Model{
		count: 0,
		keys:  defaultKeyMap(),
	}
}

// Init implements tea.Model
func (m Model) Init() tea.Cmd {
	return nil
}

// Update implements tea.Model
func (m Model) Update(msg tea.Msg) (tea.Model, tea.Cmd) {
	switch msg := msg.(type) {
	case tea.KeyMsg:
		switch {
		case key.Matches(msg, m.keys.Up):
			m.count++
		case key.Matches(msg, m.keys.Down):
			m.count--
		case key.Matches(msg, m.keys.Quit):
			m.quitting = true
			return m, tea.Quit
		}
	}
	return m, nil
}
EOF

# Create internal/tui/view.go
cat > "$PROJECT_DIR/internal/tui/view.go" << 'EOF'
package tui

import (
	"fmt"

	"github.com/charmbracelet/lipgloss"
)

var (
	titleStyle = lipgloss.NewStyle().
			Bold(true).
			Foreground(lipgloss.Color("#FAFAFA")).
			Background(lipgloss.Color("#7D56F4")).
			Padding(0, 1)

	countStyle = lipgloss.NewStyle().
			Foreground(lipgloss.Color("#7D56F4")).
			Bold(true)

	helpStyle = lipgloss.NewStyle().
			Foreground(lipgloss.Color("#626262"))
)

// View implements tea.Model
func (m Model) View() string {
	if m.quitting {
		return ""
	}

	title := titleStyle.Render("Welcome to your TUI app")
	count := fmt.Sprintf("\nCount: %s\n", countStyle.Render(fmt.Sprintf("%d", m.count)))
	help := helpStyle.Render("\nj/k: adjust count • q: quit")

	return title + count + help
}
EOF

# Create internal/tui/keys.go
cat > "$PROJECT_DIR/internal/tui/keys.go" << 'EOF'
package tui

import "github.com/charmbracelet/bubbles/key"

type keyMap struct {
	Up   key.Binding
	Down key.Binding
	Quit key.Binding
}

func defaultKeyMap() keyMap {
	return keyMap{
		Up: key.NewBinding(
			key.WithKeys("k", "up"),
			key.WithHelp("k/↑", "increment"),
		),
		Down: key.NewBinding(
			key.WithKeys("j", "down"),
			key.WithHelp("j/↓", "decrement"),
		),
		Quit: key.NewBinding(
			key.WithKeys("q", "ctrl+c"),
			key.WithHelp("q", "quit"),
		),
	}
}
EOF

# Create .gitignore
cat > "$PROJECT_DIR/.gitignore" << 'EOF'
# Binaries
/bin/
*.exe
*.exe~
*.dll
*.so
*.dylib

# Test binary
*.test

# Output of go coverage
*.out

# Go workspace
go.work
go.work.sum

# IDE
.idea/
.vscode/
*.swp
*.swo

# OS
.DS_Store

# devenv
.devenv/
.direnv/
EOF

# Create README.md
cat > "$PROJECT_DIR/README.md" << EOF
# $PROJECT_NAME

A terminal UI application built with Go, Bubble Tea, and lipgloss.

## Getting Started

\`\`\`bash
# Install dependencies
go mod tidy

# Run the app
go run .

# Build
go build -o bin/$PROJECT_NAME .
\`\`\`

## Keyboard Shortcuts

- \`j\` / \`k\` or arrow keys: Adjust counter
- \`q\` or \`Ctrl+C\`: Quit

## Project Structure

\`\`\`
.
├── main.go              # Entry point
└── internal/
    └── tui/
        ├── model.go     # Application state & Update logic
        ├── view.go      # Rendering & styles
        └── keys.go      # Keyboard bindings
\`\`\`

## Dependencies

- [Bubble Tea](https://github.com/charmbracelet/bubbletea) - TUI framework
- [Lip Gloss](https://github.com/charmbracelet/lipgloss) - Styling
- [Bubbles](https://github.com/charmbracelet/bubbles) - Common components
EOF

# Optional: devenv setup
if [[ "$WITH_DEVENV" == true ]]; then
    # Create devenv.yaml
    cat > "$PROJECT_DIR/devenv.yaml" << 'EOF'
inputs:
  nixpkgs:
    url: github:cachix/devenv-nixpkgs/rolling
EOF

    # Create devenv.nix
    cat > "$PROJECT_DIR/devenv.nix" << 'EOF'
{ pkgs, ... }:

{
  packages = with pkgs; [
    git
  ];

  languages.go.enable = true;

  enterShell = ''
    echo "Go development environment ready"
    go version
  '';
}
EOF

    # Create .envrc
    cat > "$PROJECT_DIR/.envrc" << 'EOF'
use devenv
EOF

    log_success "Created devenv setup"
fi

log_success "Created project structure"

# Initialize git repo
cd "$PROJECT_DIR"
git init -q
log_success "Initialized git repository"

# Install dependencies
log_info "Installing dependencies..."
if command -v go &> /dev/null; then
    go mod tidy
    log_success "Dependencies installed"
else
    log_warn "go not found in PATH. Run 'go mod tidy' manually."
fi

echo ""
log_success "Project created successfully!"
echo ""
echo "Next steps:"
echo "  cd $PROJECT_DIR"
[[ "$WITH_DEVENV" == true ]] && echo "  direnv allow  # if using devenv"
echo "  go run .     # start the app"
echo ""

#!/usr/bin/env bash

# Construct a .ssh/config based on files in ~/.ssh/config.d

set -e

WARNING="## Automatically generated by load-ssh; edit ~/.ssh/config.d/ files instead."

if ! grep -q "$WARNING" $HOME/.ssh/config; then
	if [ "$1" != "-f" ]; then
		echo "load-ssh: Current .ssh/config was not generated by load-ssh; not changing." >&2
		echo "load-ssh: Use load-ssh -f to override"
		exit 1
	else
		cp $HOME/.ssh/config $HOME/.ssh/config.old
		echo "load-ssh: Old ssh config is backed up to $HOME/.ssh/config.old"
	fi
fi

dir=$HOME/.ssh/config.d
if [ -d "$dir" ]; then
	(
		echo "$WARNING"
		echo
		for f in $dir/*; do
			echo "## From $dir/$f:"
			echo
			cat $f
			echo
		done
	) > $HOME/.ssh/config
fi
